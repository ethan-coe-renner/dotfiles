- name: Bootstrap dotfiles
  hosts: localhost

  tasks:
    - name: Include package vars
      ansible.builtin.include_vars:
        file: packages.yaml

    - name: Install packages with dnf
      become: yes
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: latest
      loop: "{{ packages.linux.fedora }}"
      when: ansible_distribution == 'Fedora'

    - name: Install packages with homebrew
      community.general.homebrew:
        name: "{{ item }}"
        state: present
        force_formula: true
      loop: "{{ packages.darwin.brew }}"
      when: ansible_facts['os_family'] == "Darwin"

    - name: Install packages with homebrew cask
      community.general.homebrew_cask:
        name: "{{ item }}"
        state: present
      loop: "{{ packages.darwin.cask }}"
      when: ansible_facts['os_family'] == "Darwin"

    # --- Rust ---
    - name: Check if cargo is installed
      stat:
        path: /home/ethan/.cargo
      register: cargo_exists
      tags: rust

    - name: Download Rustup
      when: cargo_exists is failed
      get_url:
        url: https://sh.rustup.rs
        dest: /tmp/sh.rustup.rs
        mode: '0755'
      tags: rust

    - name: install rustup
      when: cargo_exists is failed
      shell: /tmp/sh.rustup.rs -y
      tags: rust

    - name: Install packages with cargo
      community.general.cargo:
        name: "{{ item }}"
      loop: "{{ packages.cargo.unlocked }}"
      tags: rust

    - name: Install locked packages with cargo
      community.general.cargo:
        name: "{{ item }}"
        locked: true
      loop: "{{ packages.cargo.locked }}"
      tags: rust

    # --- KMonad ---
    - name: Download KMonad
      ansible.builtin.git:
        repo: https://github.com/kmonad/kmonad
        dest: /home/ethan/.local/repos/kmonad
        depth: 1
      register: download_kmonad
      tags: kmonad

    - name: Install Kmonad
      shell: stack install
      args:
        chdir: /home/ethan/.local/repos/kmonad
        creates: /home/ethan/.local/bin/kmonad
      when: download_kmonad.changed
      tags: kmonad

    # --- Fonts ---
    - name: Install Iosevka Comfy Font
      ansible.builtin.git:
        repo: https://github.com/protesilaos/iosevka-comfy
        dest: "$HOME/.local/share/fonts/iosevka-comfy"
        depth: 1
      tags: font

    - name: Install Fira Code Nerd Font
      unarchive:
        src: https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.tar.xz
        dest: /home/ethan/.local/share/fonts
        remote_src: yes
      tags: font

    # --- Doom Emacs ---
    - name: Download Doom Emacs
      ansible.builtin.git:
        repo: https://github.com/doomemacs/doomemacs
        dest: /home/ethan/.config/emacs
        depth: 1
      register: download_doom
      tags: emacs

    - name: Install Doom Emacs
      ansible.builtin.command: /home/ethan/.config/emacs/bin/doom install
      when: download_doom.changed
      tags: emacs

    # --- Services ---
    - name: Include service vars
      ansible.builtin.include_vars:
        file: services.yaml

    - name: Enable Systemd User Services
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        state: started
        enabled: true
        scope: user
      loop: "{{ services.user }}"
